services:
  app:
    build: .
    container_name: laravel-app
    restart: always
    ports:
      - '80:80'
      - '443:443'
    env_file:
      - .env

    # OVERRIDE CONFIGURATION FOR DOCKER NETWORKING
    environment:
      # 1. Setting Koneksi Default / Tako Perusahaan
      # We point host to 'db' (container name) instead of 127.0.0.1
      - DB_CONNECTION=pgsql
      - DB_HOST=db
      - DB_PORT=5432
      - DB_DATABASE=${DB_SECOND_DATABASE}
      - DB_USERNAME=${DB_SECOND_USERNAME}
      - DB_PASSWORD=${DB_SECOND_PASSWORD}

      # 2. Setting Koneksi User / Central (tako-user)
      # Based on your config/database.php using DB_SECOND_*
      - DB_SECOND_CONNECTION=pgsql
      - DB_SECOND_HOST=db
      - DB_SECOND_PORT=5432
      - DB_SECOND_DATABASE=${DB_SECOND_DATABASE}
      - DB_SECOND_USERNAME=${DB_SECOND_USERNAME}
      - DB_SECOND_PASSWORD=${DB_SECOND_PASSWORD}

      # 3. Setting Koneksi Tako Perusahaan (tako-perusahaan)
      # Assuming it shares the same DB instance in local docker, or mapped similarly
      - DB_TAKO_CONNECTION=pgsql
      - DB_TAKO_HOST=db
      - DB_TAKO_PORT=5432
      # If these variables aren't in .env, they will default to empty or need to be added
      - DB_TAKO_DATABASE=${DB_TAKO_DATABASE:-${DB_SECOND_DATABASE}}
      - DB_TAKO_USERNAME=${DB_TAKO_USERNAME:-${DB_SECOND_USERNAME}}
      - DB_TAKO_PASSWORD=${DB_TAKO_PASSWORD:-${DB_SECOND_PASSWORD}}

      # Setup URL
      - APP_URL=${APP_URL}
      - FILESYSTEM_DISK=${FILESYSTEM_DISK:-public}

    volumes:
      - ./:/var/www/html
      # Mounting storage public for consistency
      - ./storage/app/public:/var/www/html/storage/app/public

      # UPDATED: Mounting /mnt/Ppjk based on config/filesystem.php 'customers_external'
      # Format: path_on_host:path_in_container
      - /mnt/Ppjk:/mnt/Ppjk

      - /etc/hosts:/tmp/hosts_external:ro

    depends_on:
      - db
    networks:
      - app-network

  reverb:
    image: <gunakan_image_yang_sama_dengan_app_anda> # misal: sail-8.3/app atau nama image custom
    command: php artisan reverb:start --host=0.0.0.0 --port=8080
    ports:
      - '8080:8080'
    environment:
      WWWUSER: ${WWWUSER}
      LARAVEL_SAIL: 1
      XDEBUG_MODE: '${SAIL_XDEBUG_MODE:-off}'
      XDEBUG_CONFIG: '${SAIL_XDEBUG_CONFIG:-client_host=host.docker.internal}'
      IGNITION_LOCAL_SITES_PATH: '${PWD}'
    volumes:
      - '.:/var/www/html'
    networks:
      - sail # atau nama network docker yang Anda gunakan
    depends_on:
      - redis # Reverb membutuhkan Redis untuk scaling (opsional tapi direkomendasikan)

  db:
    image: postgres:15
    container_name: postgres-db
    restart: always
    environment:
      # Using DB_SECOND credentials from .env to initialize the master DB
      POSTGRES_DB: ${DB_SECOND_DATABASE}
      POSTGRES_USER: ${DB_SECOND_USERNAME}
      POSTGRES_PASSWORD: ${DB_SECOND_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - app-network
    ports:
      - '${DB_SECOND_PORT:-5432}:5432'

networks:
  app-network:
    driver: bridge

volumes:
  postgres_data:
